# sprite-mobile Management Skill

Use this skill when working with sprite-mobile - a Progressive Web App chat UI for accessing Claude Code on a Sprite. This skill provides context about architecture, service management, development workflows, and sprite orchestration.

## Architecture Overview

### Two-Service Design

sprite-mobile uses a **dual-service architecture** for secure access:

```
Public URL (https://sprite.fly.dev)
         â”‚
         â–¼
   tailnet-gate (port 8080)
         â”‚
         â”œâ”€â”€ Embeds iframe with Tailscale HTTPS URL
         â”‚   â”‚
         â”‚   â”œâ”€â”€ On tailnet? â”€â”€â†’ Shows sprite-mobile interface
         â”‚   â”‚                   (WebSocket keeps sprite awake)
         â”‚   â”‚
         â”‚   â””â”€â”€ Not on tailnet (4s timeout)? â”€â”€â†’ Shows "Unauthorized" ğŸ‘¾ ğŸš«
         â”‚
         â””â”€â”€ Hash syncing â”€â”€â†’ Deep linking to specific chat sessions

   sprite-mobile (port 8081)
         â”‚
         â””â”€â”€ Accessed via Tailscale HTTPS (https://hostname.ts.net)
```

**Key Services:**
- `tailnet-gate` (port 8080): Public entry point, embeds Tailscale URL in iframe
  - Location: `~/.tailnet-gate/server.ts`
  - Generated by: `sprite-setup.sh` (step 10)
  - Purpose: Wake sprite, provide keepalive, show unauthorized page if not on tailnet

- `sprite-mobile` (port 8081): Main app server, Claude Code chat interface
  - Location: `~/.sprite-mobile/`
  - Started via: `~/.sprite-mobile/scripts/start-service.sh` (sources `~/.sprite-config`)
  - Purpose: WebSocket-based chat interface with Claude Code in YOLO mode

- `tailscaled`: Tailscale daemon for secure network access

### Access Model

**Three access paths:**

| Path | URL | Auth | HTTPS | PWA |
|------|-----|------|-------|-----|
| Public | `https://sprite.fly.dev` | Tailnet Gate | Yes | Via iframe |
| Tailscale Serve | `https://hostname.ts.net` | Tailnet only | Yes | Yes |
| Tailscale IP | `http://100.x.x.x:8081` | Tailnet only | No | No |

**Recommended**: Bookmark the public URL. The tailnet-gate wakes the sprite and embeds the Tailscale HTTPS URL in an iframe with hash syncing for deep linking.

### Data Storage

All data stored in `~/.sprite-mobile/data/`:
- `sessions.json` - Chat session metadata
- `sprites.json` - Saved Sprite profiles
- `messages/{sessionId}.json` - Message history per session
- `uploads/{sessionId}/` - Uploaded images per session

## Service Management

### Viewing Service Status

```bash
# List all services
sprite-env services list

# View logs for a specific service
sprite-env services logs sprite-mobile
sprite-env services logs tailnet-gate
sprite-env services logs tailscaled
```

### Restarting Services

**IMPORTANT**: Always use `stop` then `start` (NOT `restart`):

```bash
# Restart sprite-mobile
sprite-env services stop sprite-mobile
sprite-env services start sprite-mobile

# Restart tailnet-gate
sprite-env services stop tailnet-gate
sprite-env services start tailnet-gate
```

The `start-service.sh` wrapper automatically:
- Sources `~/.sprite-config` for environment variables
- Runs `git pull` to auto-update
- Installs dependencies via `bun install`
- Starts the server with `bun run server.ts`

### Service Auto-Update

On each service start, sprite-mobile:
1. Pulls latest code via `git pull`
2. Installs dependencies via `bun install`
3. Starts the server

This means all sprites auto-update when they wake up.

## Scripts Reference

All helper scripts are located in `~/.sprite-mobile/scripts/`. These scripts automate common sprite-mobile management tasks.

### update-all-sprites.sh

**Purpose**: Update and restart sprite-mobile on all other sprite-mobile sprites in your network

**Usage**:
```bash
cd ~/.sprite-mobile
./scripts/update-all-sprites.sh
```

**What it does**:
1. Gets list of all sprites from `sprite list`
2. For each sprite (excluding current):
   - Pulls latest code from git (with GitHub auth)
   - Restarts sprite-mobile service (re-registers if needed via step 8)
   - Regenerates and restarts tailnet-gate service (via step 10)
3. Shows summary of successes and failures

**When to use**:
- After pushing updates to sprite-mobile
- When you want to ensure all sprites are on the latest version
- After making configuration changes that affect all sprites

**Example output**:
```
[hanoi-winter] Updating sprite-mobile...
  âœ“ Code pulled
  âœ“ Service restarted
  âœ“ Tailnet-gate updated
  âœ“ Complete

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
Update complete!
  Success: 5
  Failed: 0
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
```

**Claude usage**: When user says "update and restart the other sprite-mobile sprites", run this script.

### restart-others.sh

**Purpose**: Restart sprite-mobile service on all other sprites (lighter version of update-all-sprites.sh)

**Usage**:
```bash
cd ~/.sprite-mobile
./scripts/restart-others.sh
```

**What it does**:
- Sends SIGTERM to sprite-mobile service on each sprite
- Services auto-restart and pull latest code (via start-service.sh auto-update)

**When to use**:
- Quick restart when you know code is already pulled
- When you only need services to restart (not regenerate tailnet-gate)

### create-sprite.sh

**Purpose**: Create a new sprite-mobile sprite from an existing one

**Usage**:
```bash
~/.sprite-mobile/scripts/create-sprite.sh <sprite-name>
```

**What it does**:
1. Creates new sprite with given name
2. Makes its URL public
3. Transfers `~/.sprite-config` (excluding sprite-specific URLs)
4. Downloads and runs setup script non-interactively
5. Verifies all services are running

**When to use**:
- Creating a new sprite-mobile sprite
- Replicating your sprite-mobile setup to a new sprite

**Example**:
```bash
./scripts/create-sprite.sh my-new-sprite
```

See "Creating New Sprites" section for detailed documentation.

### sprite-setup.sh

**Purpose**: Main setup script for sprite-mobile installation and configuration

**Usage**:
```bash
# Run all steps interactively
./scripts/sprite-setup.sh

# Run all steps non-interactively (with config)
./scripts/sprite-setup.sh --config config.json --name my-sprite all

# Run specific steps only
./scripts/sprite-setup.sh 8        # Re-register sprite-mobile service
./scripts/sprite-setup.sh 10       # Regenerate tailnet-gate
./scripts/sprite-setup.sh 1-4 8 11 # Multiple steps

# Export current config
./scripts/sprite-setup.sh --export
```

**Steps**:
1. Install Sprites CLI and authenticate
2. Configure hostname, git user, URLs, and repo
3. Authenticate Claude CLI
4. Authenticate GitHub CLI
5. Install Fly.io CLI
6. Install and configure Tailscale
7. Set up Tailscale Serve (HTTPS)
8. Clone and run sprite-mobile (or re-register service)
9. Set up Sprite Network credentials
10. Start Tailnet Gate
11. Create CLAUDE.md

**When to use**:
- Initial sprite-mobile installation
- Re-registering services (step 8 after script path changes)
- Regenerating tailnet-gate (step 10)
- Fixing broken configuration

### start-service.sh

**Purpose**: Service wrapper that starts sprite-mobile with proper environment

**Usage**: Called automatically by sprite-env, not meant to be run directly

**What it does**:
- Sources `~/.sprite-config` for environment variables
- Runs `git pull` to auto-update code
- Installs dependencies via `bun install`
- Starts server with `bun run server.ts`

**Service registration** (in sprite-env):
```json
{
  "name": "sprite-mobile",
  "cmd": "/home/sprite/.sprite-mobile/scripts/start-service.sh"
}
```

## Development Workflows

### Making Changes to sprite-mobile

When modifying the sprite-mobile app code:

1. **Make your changes** (edit files in `~/.sprite-mobile/`)

2. **Update service worker cache version** if you changed:
   - HTML/CSS/JavaScript in `public/`
   - API endpoints or behavior
   - Any user-facing functionality

   Edit `public/service-worker.js`:
   ```javascript
   const CACHE_VERSION = 'v1.2.3'; // Increment this
   ```

3. **Test locally** (optional):
   ```bash
   cd ~/.sprite-mobile
   bun run server.ts
   ```

4. **Restart the service**:
   ```bash
   sprite-env services stop sprite-mobile
   sprite-env services start sprite-mobile
   ```

5. **Commit and push**:
   ```bash
   cd ~/.sprite-mobile
   git add .
   git commit -m "Description of changes"
   git push
   ```

6. **Update other sprites** (if you have a sprite network):
   ```bash
   cd ~/.sprite-mobile
   ./scripts/update-all-sprites.sh
   ```
   This script updates all other sprite-mobile sprites (pulls code, restarts services, regenerates tailnet-gate).

   For a quicker restart (without regenerating tailnet-gate):
   ```bash
   ./scripts/restart-others.sh
   ```

### Why Service Worker Cache Versioning Matters

sprite-mobile is a PWA (Progressive Web App) with offline support. The service worker caches static assets for offline use. When you make changes:

- **Without version bump**: Users may see stale cached content
- **With version bump**: Service worker invalidates old cache and fetches fresh content

**When to bump the version:**
- Changed HTML, CSS, or JavaScript
- Modified API endpoints or responses
- Updated static assets (icons, images)
- Changed app behavior or UI

**When you can skip:**
- Backend-only changes (no user-facing impact)
- Log messages or internal refactoring
- Configuration changes

## Creating and Managing Other Sprites

### Prerequisites

For fully automated sprite creation, you need:
1. **Tailscale reusable auth key** (saved to `~/.sprite-config`)
2. **Authenticated CLI tools** (Claude, GitHub, Fly.io)
3. **Sprite Network credentials** (optional, for auto-discovery)

### Creating a New sprite-mobile Sprite

From an existing sprite-mobile sprite:

```bash
# Set the new sprite's name
NEW_SPRITE="my-new-sprite"

# 1. Create the sprite
sprite create $NEW_SPRITE

# 2. Make its URL public
sprite url update --auth public -s $NEW_SPRITE

# 3. Export config and run setup on the new sprite
~/.sprite-mobile/scripts/sprite-setup.sh --export | \
  sprite -s $NEW_SPRITE exec bash -c "
    curl -fsSL https://raw.githubusercontent.com/clouvet/sprite-mobile/main/sprite-setup.sh -o ~/sprite-setup.sh
    chmod +x ~/sprite-setup.sh
    ~/sprite-setup.sh --config - --name $NEW_SPRITE all
  "
```

This fully automates the setup process using your existing credentials.

### What Gets Transferred

The `--export` config includes:
- Git configuration (user.name, user.email)
- Claude CLI credentials
- GitHub CLI credentials
- Fly.io CLI credentials
- Sprite Network credentials (if configured)
- Tailscale reusable auth key (if configured)
- Port settings

**Not transferred** (unique per sprite):
- Hostname (set via `--name`)
- Public URL (derived from name or set via `--url`)

### Setup Script Usage

```bash
# Export current sprite's config
~/.sprite-mobile/scripts/sprite-setup.sh --export > config.json

# Run non-interactively with config file
./sprite-setup.sh --config config.json all

# Run with explicit name/URL for new sprite
./sprite-setup.sh --config config.json --name my-sprite --url https://my-sprite.fly.dev all

# Run specific steps only
./sprite-setup.sh --config config.json --name my-sprite 1-4 8 11
```

**Setup Steps:**
1. Sprites CLI installation and auth
2. Configuration (URLs, repo, git)
3. Claude CLI authentication
4. GitHub CLI authentication
5. Fly.io CLI (flyctl) installation
6. Tailscale installation
7. Tailscale Serve (HTTPS for PWA)
8. sprite-mobile setup
9. Sprite Network (optional)
10. Tailnet Gate (public entry point)
11. CLAUDE.md creation

## Configuration Management

### ~/.sprite-config

Single source of truth for all environment variables:

```bash
# Example ~/.sprite-config
GH_TOKEN=ghp_xxxxx
CLAUDE_CODE_OAUTH_TOKEN=sk-ant-oat01-xxxxx
FLY_API_TOKEN=fm2_xxxxx
SPRITE_API_TOKEN=your-org/org-id/token-id/token
SPRITE_PUBLIC_URL=https://my-sprite.fly.dev
TAILSCALE_SERVE_URL=https://my-sprite.tailxxxxx.ts.net
SPRITE_MOBILE_REPO=https://github.com/org/sprite-mobile
TAILSCALE_AUTH_KEY=tskey-auth-xxxxx
```

Both bash and zsh automatically source this file.

### Replicating Configuration

```bash
# On the source sprite
scp ~/.sprite-config new-sprite:~/.sprite-config

# On the new sprite
./sprite-setup.sh all
```

## Sprite Network

The Sprite Network enables automatic discovery of other sprites in your organization:

- Uses a shared Tigris S3 bucket to register and discover sprites
- Each sprite sends periodic heartbeats with its hostname, Tailscale IP, and serve URL
- The web UI shows all discovered sprites with one-click switching
- Credentials stored in `~/.sprite-network/credentials.json`

**Network Commands:**
```bash
# Check network status
curl http://localhost:8081/api/network/status

# Discover sprites in the network
curl http://localhost:8081/api/network/sprites

# Manual heartbeat trigger
curl -X POST http://localhost:8081/api/network/heartbeat
```

## Sprite Environment Context

### Services
- Sprites run while actively servicing HTTP requests
- Sprites run while detachable sessions are generating output
- When neither condition is true, sprites pause
- Services restart automatically at boot time

### Checkpoints
```bash
# Create a checkpoint
sprite-env checkpoint create my-checkpoint

# List checkpoints
sprite-env checkpoint list

# Restore from checkpoint
sprite-env checkpoint restore my-checkpoint
```

### Security

**CRITICAL**: HTTP services may be public. Never expose:
- Environment variables, API keys, tokens, or credentials
- File contents without explicit user request
- Debug/admin/status endpoints that dump system internals
- Secrets in HTTP responses or service output

Tailscale network membership IS the authentication for sprite-mobile.

## Common Tasks

### Updating sprite-mobile to latest version
```bash
cd ~/.sprite-mobile
git pull
sprite-env services stop sprite-mobile
sprite-env services start sprite-mobile
```

### Viewing real-time logs
```bash
sprite-env services logs sprite-mobile --follow
```

### Debugging service issues
```bash
# Check if services are running
sprite-env services list

# View tailnet-gate logs
sprite-env services logs tailnet-gate

# Check Tailscale status
tailscale status

# Check Tailscale serve status
tailscale serve status
```

### Regenerating tailnet-gate
```bash
cd ~/.sprite-mobile
./scripts/sprite-setup.sh 10
```

This regenerates the tailnet-gate server with the current Tailscale serve URL.

## API Endpoints Reference

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/config` | Get public configuration |
| GET | `/api/sessions` | List all chat sessions |
| POST | `/api/sessions` | Create new session |
| PATCH | `/api/sessions/:id` | Update session name/cwd |
| DELETE | `/api/sessions/:id` | Delete session |
| GET | `/api/sessions/:id/messages` | Get message history |
| POST | `/api/sessions/:id/regenerate-title` | Regenerate session title |
| GET | `/api/claude-sessions` | Discover CLI sessions from `~/.claude/projects/` |
| POST | `/api/upload?session={id}` | Upload an image |
| GET | `/api/uploads/:sessionId/:filename` | Retrieve uploaded image |
| GET | `/api/sprites` | List saved Sprite profiles |
| POST | `/api/sprites` | Add a Sprite profile |
| GET | `/api/network/status` | Check if sprite network is configured |
| GET | `/api/network/sprites` | Discover sprites in the network |

## WebSocket Protocol

Connect to `/ws?session={sessionId}` for real-time chat.

**From server:**
- `{ type: "history", messages: [...] }` - Initial message history
- `{ type: "assistant", message: {...} }` - Streaming response
- `{ type: "result", ... }` - Response complete
- `{ type: "processing", isProcessing: true/false }` - Processing state
- `{ type: "refresh_sessions" }` - Session list changed

**To server:**
```json
{
  "type": "user",
  "content": "Your message here",
  "imageId": "optional-image-id",
  "imageFilename": "optional-filename",
  "imageMediaType": "image/png"
}
```

## Distributed Tasks

sprite-mobile supports distributing tasks across multiple sprites in your network. This allows one sprite to assign work to other sprites and track progress.

### Core Concepts

**Tasks**: Work items that can be assigned to sprites
- Each task has: title, description, assigned sprite, status, and result
- Status: `pending` â†’ `in_progress` â†’ `completed`/`failed`/`abandoned`
- Tasks are queued per sprite and executed sequentially
- Tasks can be cancelled (status becomes `abandoned`) or reassigned to different sprites
- Task data stored in Tigris bucket (`tasks/` and `task-queues/` prefixes)

**Task Queue**: Each sprite has its own queue
- Tasks are processed one at a time
- When a task completes, the sprite automatically checks for the next one
- Tasks create new Claude Code sessions with the task description

### Assigning Tasks

**From Chat (recommended):**

User talks to Claude on one sprite and asks it to assign tasks:

```
"Assign hanoi-winter to implement feature X"
"Distribute these 4 tasks across available sprites"
```

Claude will:
1. Create task(s) in Tigris
2. Wake target sprites using `sprite exec`
3. Target sprites auto-create sessions and start work

**Via API:**

```bash
# Assign specific task
curl -X POST http://localhost:8081/api/distributed-tasks \
  -H "Content-Type: application/json" \
  -d '{
    "assignedTo": "hanoi-winter",
    "title": "Implement feature X",
    "description": "Detailed task description..."
  }'

# Distribute tasks round-robin
curl -X POST http://localhost:8081/api/distributed-tasks/distribute \
  -H "Content-Type: application/json" \
  -d '{
    "taskDescriptions": [
      {"title": "Task 1", "description": "..."},
      {"title": "Task 2", "description": "..."}
    ]
  }'
```

### Completing Tasks

When Claude finishes a task, it should call:

```bash
curl -X POST http://localhost:8081/api/distributed-tasks/complete \
  -H "Content-Type: application/json" \
  -d '{
    "summary": "Completed feature X by implementing Y and Z",
    "success": true
  }'
```

The sprite will automatically check for the next queued task.

### Cancelling Tasks

Any sprite can cancel a task by ID:

```bash
# Cancel a task (removes from queue and marks as abandoned)
curl -X POST http://localhost:8081/api/distributed-tasks/{task-id}/cancel \
  -H "Content-Type: application/json" \
  -d '{"reason": "Optional cancellation reason"}'
```

This will:
- Mark the task as `abandoned`
- Remove it from the assigned sprite's queue
- Clear it from the current task if it's in progress
- Store optional cancellation reason

**From chat:**
```
"Cancel task {task-id}"
"Cancel the task assigned to hanoi-winter"
```

### Reassigning Tasks

Any sprite can reassign a task to a different sprite:

```bash
# Reassign a task to a different sprite
curl -X POST http://localhost:8081/api/distributed-tasks/{task-id}/reassign \
  -H "Content-Type: application/json" \
  -d '{
    "newAssignee": "new-sprite-name",
    "reason": "Optional reassignment reason"
  }'
```

This will:
- Remove task from old sprite's queue
- Reset task status to `pending`
- Add task to new sprite's queue
- Wake the new sprite to pick up the task
- Store optional reassignment reason
- Cannot reassign completed or failed tasks

**From chat:**
```
"Reassign task {task-id} to hanoi-winter"
"Move the task from sad-clown to eternus-failurus"
```

### Querying Status

**My tasks:**
```bash
curl http://localhost:8081/api/distributed-tasks/mine
```

**All sprites status:**
```bash
curl http://localhost:8081/api/distributed-tasks/status
```

**All tasks:**
```bash
curl http://localhost:8081/api/distributed-tasks
```

**In chat:**
```
"What are the other sprites working on?"
"Show me the status of all tasks"
```

Claude will query the API and summarize the results.

### UI

The tasks modal (ğŸ“‹ button in header) shows:
- **My Tasks**: Current and queued tasks for this sprite
- **All Sprites Status**: What each sprite is working on
- **All Tasks**: Complete task history

### Task Flow Example

1. **sad-clown assigns tasks to hanoi-winter:**
   ```
   User: "Assign hanoi-winter to implement features A, B, and C"
   ```

2. **sad-clown's Claude:**
   - Creates 3 tasks in Tigris
   - Wakes hanoi-winter with `sprite exec`

3. **hanoi-winter receives tasks:**
   - API endpoint `/api/distributed-tasks/check` is called
   - Gets first task from queue
   - Creates Claude session with task description
   - Marks task as `in_progress`

4. **hanoi-winter works:**
   - Claude completes the task
   - Calls `/api/distributed-tasks/complete` with summary
   - Automatically picks up next task (B)

5. **Querying from eternus-failurus:**
   ```
   User: "What are the other sprites working on?"
   Claude: "sad-clown is idle. hanoi-winter is working on 'Implement feature B' and has 1 task queued."
   ```

### API Reference

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/api/distributed-tasks` | Create a task |
| POST | `/api/distributed-tasks/distribute` | Distribute tasks to sprites |
| POST | `/api/distributed-tasks/check` | Check for new tasks (called by sprite exec) |
| POST | `/api/distributed-tasks/complete` | Mark current task complete |
| POST | `/api/distributed-tasks/:id/cancel` | Cancel a task (aborts if in progress, removes from queue if pending) |
| POST | `/api/distributed-tasks/:id/reassign` | Reassign a task to a different sprite (updates queue accordingly) |
| GET | `/api/distributed-tasks` | List all tasks |
| GET | `/api/distributed-tasks/mine` | Get my tasks (current + queued) |
| GET | `/api/distributed-tasks/status` | Get all sprites status |
| GET | `/api/distributed-tasks/:id` | Get specific task |
| PATCH | `/api/distributed-tasks/:id` | Update task |

### Cancelling Tasks

**From Chat:**
```
"Cancel task {task-id}"
"Abort the task that hanoi-winter is working on"
```

**Via API:**
```bash
curl -X POST http://localhost:8081/api/distributed-tasks/{task-id}/cancel \
  -H "Content-Type: application/json" \
  -d '{"reason": "Optional cancellation reason"}'
```

**Behavior:**
- If task is `pending`: Removes from queue, marks as `cancelled`
- If task is `in_progress`: Marks as `cancelled` (sprite should check status and stop working)
- Updates task with `cancelledAt` timestamp and optional `cancelReason`

### Reassigning Tasks

**From Chat:**
```
"Reassign task {task-id} to eternus-failurus"
"Move hanoi-winter's queued tasks to sad-clown"
```

**Via API:**
```bash
curl -X POST http://localhost:8081/api/distributed-tasks/{task-id}/reassign \
  -H "Content-Type: application/json" \
  -d '{"newAssignedTo": "eternus-failurus"}'
```

**Behavior:**
- Updates task's `assignedTo` field
- Removes from old sprite's queue
- Adds to new sprite's queue
- Wakes new sprite using `sprite exec`
- Only works for `pending` tasks (cannot reassign in-progress tasks)

### Important Notes

- Tasks require sprite network to be configured (same Tigris bucket)
- Sprites check for sprite existence using `sprite list` API
- Tasks for destroyed sprites remain in `pending` state
- Claude should ask user before assigning tasks (don't auto-assign without confirmation)
- Task sessions are created with task description as initial message
- Sprites automatically process queued tasks after completing current task

## Quick Reference

**Project location**: `~/.sprite-mobile/`
**Configuration**: `~/.sprite-config`
**Data directory**: `~/.sprite-mobile/data/`
**Setup script**: `~/.sprite-mobile/scripts/sprite-setup.sh`
**Service wrapper**: `~/.sprite-mobile/scripts/start-service.sh`

**Key files to know:**
- `server.ts` - Main app server
- `public/service-worker.js` - PWA cache (bump version when deploying changes)
- `public/index.html` - Main UI
- `routes/` - API endpoint handlers
- `lib/` - Shared utilities
