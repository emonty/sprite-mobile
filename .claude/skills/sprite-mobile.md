# sprite-mobile Management Skill

Use this skill when working with sprite-mobile - a Progressive Web App chat UI for accessing Claude Code on a Sprite. This skill provides context about architecture, service management, development workflows, and sprite orchestration.

## Architecture Overview

### Two-Service Design

sprite-mobile uses a **dual-service architecture** for secure access:

```
Public URL (https://sprite.fly.dev)
         â”‚
         â–¼
   tailnet-gate (port 8080)
         â”‚
         â”œâ”€â”€ Embeds iframe with Tailscale HTTPS URL
         â”‚   â”‚
         â”‚   â”œâ”€â”€ On tailnet? â”€â”€â†’ Shows sprite-mobile interface
         â”‚   â”‚                   (WebSocket keeps sprite awake)
         â”‚   â”‚
         â”‚   â””â”€â”€ Not on tailnet (4s timeout)? â”€â”€â†’ Shows "Unauthorized" ðŸ‘¾ ðŸš«
         â”‚
         â””â”€â”€ Hash syncing â”€â”€â†’ Deep linking to specific chat sessions

   sprite-mobile (port 8081)
         â”‚
         â””â”€â”€ Accessed via Tailscale HTTPS (https://hostname.ts.net)
```

**Key Services:**
- `tailnet-gate` (port 8080): Public entry point, embeds Tailscale URL in iframe
  - Location: `~/.tailnet-gate/server.ts`
  - Generated by: `sprite-setup.sh` (step 10)
  - Purpose: Wake sprite, provide keepalive, show unauthorized page if not on tailnet

- `sprite-mobile` (port 8081): Main app server, Claude Code chat interface
  - Location: `~/.sprite-mobile/`
  - Started via: `~/.sprite-mobile/start-service.sh` (sources `~/.sprite-config`)
  - Purpose: WebSocket-based chat interface with Claude Code in YOLO mode

- `tailscaled`: Tailscale daemon for secure network access

### Access Model

**Three access paths:**

| Path | URL | Auth | HTTPS | PWA |
|------|-----|------|-------|-----|
| Public | `https://sprite.fly.dev` | Tailnet Gate | Yes | Via iframe |
| Tailscale Serve | `https://hostname.ts.net` | Tailnet only | Yes | Yes |
| Tailscale IP | `http://100.x.x.x:8081` | Tailnet only | No | No |

**Recommended**: Bookmark the public URL. The tailnet-gate wakes the sprite and embeds the Tailscale HTTPS URL in an iframe with hash syncing for deep linking.

### Data Storage

All data stored in `~/.sprite-mobile/data/`:
- `sessions.json` - Chat session metadata
- `sprites.json` - Saved Sprite profiles
- `messages/{sessionId}.json` - Message history per session
- `uploads/{sessionId}/` - Uploaded images per session

## Service Management

### Viewing Service Status

```bash
# List all services
sprite-env services list

# View logs for a specific service
sprite-env services logs sprite-mobile
sprite-env services logs tailnet-gate
sprite-env services logs tailscaled
```

### Restarting Services

**IMPORTANT**: Always use `stop` then `start` (NOT `restart`):

```bash
# Restart sprite-mobile
sprite-env services stop sprite-mobile
sprite-env services start sprite-mobile

# Restart tailnet-gate
sprite-env services stop tailnet-gate
sprite-env services start tailnet-gate
```

The `start-service.sh` wrapper automatically:
- Sources `~/.sprite-config` for environment variables
- Runs `git pull` to auto-update
- Installs dependencies via `bun install`
- Starts the server with `bun run server.ts`

### Service Auto-Update

On each service start, sprite-mobile:
1. Pulls latest code via `git pull`
2. Installs dependencies via `bun install`
3. Starts the server

This means all sprites auto-update when they wake up.

## Development Workflows

### Making Changes to sprite-mobile

When modifying the sprite-mobile app code:

1. **Make your changes** (edit files in `~/.sprite-mobile/`)

2. **Update service worker cache version** if you changed:
   - HTML/CSS/JavaScript in `public/`
   - API endpoints or behavior
   - Any user-facing functionality

   Edit `public/service-worker.js`:
   ```javascript
   const CACHE_VERSION = 'v1.2.3'; // Increment this
   ```

3. **Test locally** (optional):
   ```bash
   cd ~/.sprite-mobile
   bun run server.ts
   ```

4. **Restart the service**:
   ```bash
   sprite-env services stop sprite-mobile
   sprite-env services start sprite-mobile
   ```

5. **Commit and push**:
   ```bash
   cd ~/.sprite-mobile
   git add .
   git commit -m "Description of changes"
   git push
   ```

6. **Update other sprites** (if you have a sprite network):
   ```bash
   cd ~/.sprite-mobile
   ./scripts/restart-others.sh
   ```
   This script restarts sprite-mobile on all other network sprites, pulling your updates.

### Why Service Worker Cache Versioning Matters

sprite-mobile is a PWA (Progressive Web App) with offline support. The service worker caches static assets for offline use. When you make changes:

- **Without version bump**: Users may see stale cached content
- **With version bump**: Service worker invalidates old cache and fetches fresh content

**When to bump the version:**
- Changed HTML, CSS, or JavaScript
- Modified API endpoints or responses
- Updated static assets (icons, images)
- Changed app behavior or UI

**When you can skip:**
- Backend-only changes (no user-facing impact)
- Log messages or internal refactoring
- Configuration changes

## Creating and Managing Other Sprites

### Prerequisites

For fully automated sprite creation, you need:
1. **Tailscale reusable auth key** (saved to `~/.sprite-config`)
2. **Authenticated CLI tools** (Claude, GitHub, Fly.io)
3. **Sprite Network credentials** (optional, for auto-discovery)

### Creating a New sprite-mobile Sprite

From an existing sprite-mobile sprite:

```bash
# Set the new sprite's name
NEW_SPRITE="my-new-sprite"

# 1. Create the sprite
sprite create $NEW_SPRITE

# 2. Make its URL public
sprite url update --auth public -s $NEW_SPRITE

# 3. Export config and run setup on the new sprite
~/.sprite-mobile/sprite-setup.sh --export | \
  sprite -s $NEW_SPRITE exec bash -c "
    curl -fsSL https://raw.githubusercontent.com/clouvet/sprite-mobile/main/sprite-setup.sh -o ~/sprite-setup.sh
    chmod +x ~/sprite-setup.sh
    ~/sprite-setup.sh --config - --name $NEW_SPRITE all
  "
```

This fully automates the setup process using your existing credentials.

### What Gets Transferred

The `--export` config includes:
- Git configuration (user.name, user.email)
- Claude CLI credentials
- GitHub CLI credentials
- Fly.io CLI credentials
- Sprite Network credentials (if configured)
- Tailscale reusable auth key (if configured)
- Port settings

**Not transferred** (unique per sprite):
- Hostname (set via `--name`)
- Public URL (derived from name or set via `--url`)

### Setup Script Usage

```bash
# Export current sprite's config
~/.sprite-mobile/sprite-setup.sh --export > config.json

# Run non-interactively with config file
./sprite-setup.sh --config config.json all

# Run with explicit name/URL for new sprite
./sprite-setup.sh --config config.json --name my-sprite --url https://my-sprite.fly.dev all

# Run specific steps only
./sprite-setup.sh --config config.json --name my-sprite 1-4 8 11
```

**Setup Steps:**
1. Sprites CLI installation and auth
2. Configuration (URLs, repo, git)
3. Claude CLI authentication
4. GitHub CLI authentication
5. Fly.io CLI (flyctl) installation
6. Tailscale installation
7. Tailscale Serve (HTTPS for PWA)
8. sprite-mobile setup
9. Sprite Network (optional)
10. Tailnet Gate (public entry point)
11. CLAUDE.md creation

## Configuration Management

### ~/.sprite-config

Single source of truth for all environment variables:

```bash
# Example ~/.sprite-config
GH_TOKEN=ghp_xxxxx
CLAUDE_CODE_OAUTH_TOKEN=sk-ant-oat01-xxxxx
FLY_API_TOKEN=fm2_xxxxx
SPRITE_API_TOKEN=your-org/org-id/token-id/token
SPRITE_PUBLIC_URL=https://my-sprite.fly.dev
TAILSCALE_SERVE_URL=https://my-sprite.tailxxxxx.ts.net
SPRITE_MOBILE_REPO=https://github.com/org/sprite-mobile
TAILSCALE_AUTH_KEY=tskey-auth-xxxxx
```

Both bash and zsh automatically source this file.

### Replicating Configuration

```bash
# On the source sprite
scp ~/.sprite-config new-sprite:~/.sprite-config

# On the new sprite
./sprite-setup.sh all
```

## Sprite Network

The Sprite Network enables automatic discovery of other sprites in your organization:

- Uses a shared Tigris S3 bucket to register and discover sprites
- Each sprite sends periodic heartbeats with its hostname, Tailscale IP, and serve URL
- The web UI shows all discovered sprites with one-click switching
- Credentials stored in `~/.sprite-network/credentials.json`

**Network Commands:**
```bash
# Check network status
curl http://localhost:8081/api/network/status

# Discover sprites in the network
curl http://localhost:8081/api/network/sprites

# Manual heartbeat trigger
curl -X POST http://localhost:8081/api/network/heartbeat
```

## Sprite Environment Context

### Services
- Sprites run while actively servicing HTTP requests
- Sprites run while detachable sessions are generating output
- When neither condition is true, sprites pause
- Services restart automatically at boot time

### Checkpoints
```bash
# Create a checkpoint
sprite-env checkpoint create my-checkpoint

# List checkpoints
sprite-env checkpoint list

# Restore from checkpoint
sprite-env checkpoint restore my-checkpoint
```

### Security

**CRITICAL**: HTTP services may be public. Never expose:
- Environment variables, API keys, tokens, or credentials
- File contents without explicit user request
- Debug/admin/status endpoints that dump system internals
- Secrets in HTTP responses or service output

Tailscale network membership IS the authentication for sprite-mobile.

## Common Tasks

### Updating sprite-mobile to latest version
```bash
cd ~/.sprite-mobile
git pull
sprite-env services stop sprite-mobile
sprite-env services start sprite-mobile
```

### Viewing real-time logs
```bash
sprite-env services logs sprite-mobile --follow
```

### Debugging service issues
```bash
# Check if services are running
sprite-env services list

# View tailnet-gate logs
sprite-env services logs tailnet-gate

# Check Tailscale status
tailscale status

# Check Tailscale serve status
tailscale serve status
```

### Regenerating tailnet-gate
```bash
cd ~/.sprite-mobile
./sprite-setup.sh 10
```

This regenerates the tailnet-gate server with the current Tailscale serve URL.

## API Endpoints Reference

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/config` | Get public configuration |
| GET | `/api/sessions` | List all chat sessions |
| POST | `/api/sessions` | Create new session |
| PATCH | `/api/sessions/:id` | Update session name/cwd |
| DELETE | `/api/sessions/:id` | Delete session |
| GET | `/api/sessions/:id/messages` | Get message history |
| POST | `/api/sessions/:id/regenerate-title` | Regenerate session title |
| GET | `/api/claude-sessions` | Discover CLI sessions from `~/.claude/projects/` |
| POST | `/api/upload?session={id}` | Upload an image |
| GET | `/api/uploads/:sessionId/:filename` | Retrieve uploaded image |
| GET | `/api/sprites` | List saved Sprite profiles |
| POST | `/api/sprites` | Add a Sprite profile |
| GET | `/api/network/status` | Check if sprite network is configured |
| GET | `/api/network/sprites` | Discover sprites in the network |

## WebSocket Protocol

Connect to `/ws?session={sessionId}` for real-time chat.

**From server:**
- `{ type: "history", messages: [...] }` - Initial message history
- `{ type: "assistant", message: {...} }` - Streaming response
- `{ type: "result", ... }` - Response complete
- `{ type: "processing", isProcessing: true/false }` - Processing state
- `{ type: "refresh_sessions" }` - Session list changed

**To server:**
```json
{
  "type": "user",
  "content": "Your message here",
  "imageId": "optional-image-id",
  "imageFilename": "optional-filename",
  "imageMediaType": "image/png"
}
```

## Quick Reference

**Project location**: `~/.sprite-mobile/`
**Configuration**: `~/.sprite-config`
**Data directory**: `~/.sprite-mobile/data/`
**Setup script**: `~/.sprite-mobile/sprite-setup.sh`
**Service wrapper**: `~/.sprite-mobile/start-service.sh`

**Key files to know:**
- `server.ts` - Main app server
- `public/service-worker.js` - PWA cache (bump version when deploying changes)
- `public/index.html` - Main UI
- `routes/` - API endpoint handlers
- `lib/` - Shared utilities
