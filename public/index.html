<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#1a1a1a">
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icon-192.png">
  <title>Sprite Code</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      --bg: #1a1a1a;
      --bg-secondary: #252525;
      --bg-tertiary: #2d2d2d;
      --text: #e5e5e5;
      --text-muted: #888;
      --accent: #d4a574;
      --user-bg: #3b3b3b;
      --assistant-bg: #252525;
      --border: #333;
      --input-bg: #2d2d2d;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-top: env(safe-area-inset-top, 0px);
      --sidebar-width: 280px;
    }

    html, body {
      height: 100%;
      overflow: hidden;
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
      font-size: 16px;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    /* Layout */
    #app {
      display: flex;
      height: 100%;
      height: 100dvh;
    }

    /* Sidebar */
    #sidebar {
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      width: var(--sidebar-width);
      background: var(--bg-secondary);
      border-right: 1px solid var(--border);
      transform: translateX(-100%);
      transition: transform 0.3s ease;
      z-index: 100;
      display: flex;
      flex-direction: column;
      padding-top: var(--safe-top);
    }

    #sidebar.open {
      transform: translateX(0);
    }

    #sidebar-header {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #sidebar-header h2 {
      font-size: 17px;
      font-weight: 600;
    }

    #new-chat-btn {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: var(--accent);
      border: none;
      color: #1a1a1a;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #sessions-list {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .session-item {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: background 0.15s;
    }

    .session-item:active {
      background: var(--bg-tertiary);
    }

    .session-item.active {
      background: var(--bg-tertiary);
      border-left: 3px solid var(--accent);
    }

    .session-name {
      font-weight: 500;
      margin-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .session-preview {
      font-size: 13px;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .session-time {
      font-size: 11px;
      color: var(--text-muted);
    }

    .session-delete {
      width: 28px;
      height: 28px;
      border: none;
      background: var(--bg-tertiary);
      color: var(--text-muted);
      cursor: pointer;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }

    .session-delete:active {
      background: #ef4444;
      color: white;
    }

    /* Overlay */
    #overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
      z-index: 99;
    }

    #overlay.visible {
      opacity: 1;
      visibility: visible;
    }

    /* Main content */
    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100%;
      padding-top: var(--safe-top);
    }

    /* Header */
    header {
      flex-shrink: 0;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
    }

    #menu-btn {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    header h1 {
      font-size: 17px;
      font-weight: 600;
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #status {
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 6px;
      flex-shrink: 0;
    }

    #status::before {
      content: "";
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #666;
    }

    #status.connected::before {
      background: #4ade80;
    }

    #status.error::before {
      background: #f87171;
    }

    /* Empty state */
    #empty-state {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 32px;
      text-align: center;
      color: var(--text-muted);
    }

    #empty-state h2 {
      font-size: 20px;
      color: var(--text);
      margin-bottom: 8px;
    }

    #empty-state p {
      margin-bottom: 24px;
    }

    #empty-state button {
      padding: 12px 24px;
      background: var(--accent);
      color: #1a1a1a;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
    }

    /* Messages area */
    #messages {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 16px;
      -webkit-overflow-scrolling: touch;
      display: none;
    }

    #messages.active {
      display: block;
    }

    .message {
      margin-bottom: 16px;
      animation: fadeIn 0.2s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message-header {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 4px;
      font-weight: 500;
    }

    .message-content {
      padding: 12px 14px;
      border-radius: 16px;
      max-width: 100%;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }

    .message.user .message-content {
      background: var(--user-bg);
      border-bottom-right-radius: 4px;
    }

    .message.assistant .message-content {
      background: var(--assistant-bg);
      border: 1px solid var(--border);
      border-bottom-left-radius: 4px;
    }

    .message.system .message-content {
      background: transparent;
      color: var(--text-muted);
      font-size: 14px;
      text-align: center;
      padding: 8px;
    }

    /* Markdown content */
    .message-content p { margin-bottom: 8px; }
    .message-content p:last-child { margin-bottom: 0; }

    .message-content code {
      font-family: "SF Mono", Monaco, Consolas, monospace;
      font-size: 14px;
      background: rgba(0,0,0,0.3);
      padding: 2px 6px;
      border-radius: 4px;
    }

    .message-content pre {
      margin: 8px 0;
      padding: 12px;
      background: #0d0d0d;
      border-radius: 8px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .message-content pre code {
      background: none;
      padding: 0;
      font-size: 13px;
      line-height: 1.4;
    }

    .message-content ul, .message-content ol { margin: 8px 0; padding-left: 24px; }
    .message-content li { margin-bottom: 4px; }
    .message-content a { color: var(--accent); text-decoration: none; }
    .message-content strong { font-weight: 600; }


    /* Tool indicator */
    .tool-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .tool-indicator .spinner {
      width: 14px;
      height: 14px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* Thinking indicator */
    .thinking-indicator {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      margin-bottom: 16px;
    }

    .thinking-dots {
      display: flex;
      gap: 4px;
    }

    .thinking-dots span {
      width: 8px;
      height: 8px;
      background: var(--accent);
      border-radius: 50%;
      animation: bounce 1.4s ease-in-out infinite;
    }

    .thinking-dots span:nth-child(1) { animation-delay: 0s; }
    .thinking-dots span:nth-child(2) { animation-delay: 0.2s; }
    .thinking-dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes bounce {
      0%, 80%, 100% { transform: translateY(0); opacity: 0.4; }
      40% { transform: translateY(-6px); opacity: 1; }
    }

    .thinking-text {
      font-size: 14px;
      color: var(--text-muted);
    }

    /* Input area */
    #input-area {
      flex-shrink: 0;
      padding: 12px 16px;
      padding-bottom: calc(12px + var(--safe-bottom));
      background: var(--bg-secondary);
      border-top: 1px solid var(--border);
      display: none;
    }

    #input-area.active {
      display: block;
    }

    #input-wrapper {
      display: flex;
      gap: 10px;
      align-items: flex-end;
    }

    #input {
      flex: 1;
      min-height: 44px;
      max-height: 120px;
      padding: 10px 14px;
      background: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 22px;
      color: var(--text);
      font-size: 16px;
      font-family: inherit;
      line-height: 1.4;
      resize: none;
      outline: none;
      -webkit-appearance: none;
    }

    #input:focus { border-color: var(--accent); }
    #input::placeholder { color: var(--text-muted); }

    #send {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: var(--accent);
      border: none;
      color: #1a1a1a;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      -webkit-tap-highlight-color: transparent;
    }

    #send:disabled { opacity: 0.5; cursor: not-allowed; }
    #send:active:not(:disabled) { transform: scale(0.95); }

    /* Attach button */
    #attach-btn {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      -webkit-tap-highlight-color: transparent;
    }
    #attach-btn:active { background: var(--bg-tertiary); }
    #attach-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Image preview */
    #image-preview {
      display: none;
      padding: 8px 16px;
      padding-bottom: 0;
    }
    #image-preview.has-image { display: block; }
    #image-preview-inner {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      background: var(--bg-tertiary);
      border-radius: 12px;
      max-width: 200px;
    }
    #image-preview img {
      width: 48px;
      height: 48px;
      object-fit: cover;
      border-radius: 8px;
    }
    #image-preview-name {
      font-size: 12px;
      color: var(--text-secondary);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 100px;
    }
    #remove-image {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--bg-secondary);
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      line-height: 1;
    }
    #remove-image:active { background: var(--border); }

    /* Settings button */
    #settings-btn {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    /* Sprites Modal */
    #sprites-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
      padding: 20px;
      padding-top: calc(20px + var(--safe-top));
      padding-bottom: calc(20px + var(--safe-bottom));
    }

    #sprites-modal.open {
      display: flex;
    }

    .modal-content {
      background: var(--bg-secondary);
      border-radius: 16px;
      width: 100%;
      max-width: 400px;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .modal-header {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      font-size: 17px;
      font-weight: 600;
    }

    .modal-close {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: var(--bg-tertiary);
      border: none;
      color: var(--text);
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    /* Sprites list */
    .sprites-list {
      margin-bottom: 16px;
    }

    .sprite-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--bg-tertiary);
      border-radius: 10px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: background 0.15s;
    }

    .sprite-item:active {
      background: var(--bg);
    }

    .sprite-item.current {
      border: 2px solid var(--accent);
    }

    .sprite-info {
      flex: 1;
      min-width: 0;
    }

    .sprite-name {
      font-weight: 500;
      margin-bottom: 2px;
    }

    .sprite-address {
      font-size: 13px;
      color: var(--text-muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .sprite-delete {
      width: 28px;
      height: 28px;
      border: none;
      background: var(--bg);
      color: var(--text-muted);
      cursor: pointer;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }

    .sprite-delete:active {
      background: #ef4444;
      color: white;
    }

    .sprite-current-badge {
      font-size: 11px;
      color: var(--accent);
      background: rgba(212, 165, 116, 0.15);
      padding: 2px 6px;
      border-radius: 4px;
    }

    /* Add sprite form */
    .add-sprite-form {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .add-sprite-form input {
      padding: 12px 14px;
      background: var(--input-bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-size: 15px;
      outline: none;
    }

    .add-sprite-form input:focus {
      border-color: var(--accent);
    }

    .add-sprite-form input::placeholder {
      color: var(--text-muted);
    }

    .add-sprite-btn {
      padding: 12px;
      background: var(--accent);
      color: #1a1a1a;
      border: none;
      border-radius: 10px;
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
    }

    .add-sprite-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .sprites-empty {
      text-align: center;
      color: var(--text-muted);
      padding: 20px;
      font-size: 14px;
    }

    /* Pull to refresh */
    #pull-indicator {
      position: fixed;
      top: var(--safe-top);
      left: 50%;
      transform: translateX(-50%) translateY(-60px);
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 150;
      transition: transform 0.2s ease, opacity 0.2s ease;
      opacity: 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    #pull-indicator.visible {
      opacity: 1;
    }

    #pull-indicator.refreshing {
      transform: translateX(-50%) translateY(20px);
      opacity: 1;
    }

    #pull-indicator .pull-arrow {
      width: 20px;
      height: 20px;
      stroke: var(--accent);
      transition: transform 0.2s ease;
    }

    #pull-indicator.ready .pull-arrow {
      transform: rotate(180deg);
    }

    #pull-indicator .pull-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      display: none;
    }

    #pull-indicator.refreshing .pull-arrow {
      display: none;
    }

    #pull-indicator.refreshing .pull-spinner {
      display: block;
    }
  </style>
</head>
<body>
  <!-- Pull to refresh indicator -->
  <div id="pull-indicator">
    <svg class="pull-arrow" viewBox="0 0 24 24" fill="none" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
      <line x1="12" y1="5" x2="12" y2="19"></line>
      <polyline points="19 12 12 19 5 12"></polyline>
    </svg>
    <div class="pull-spinner"></div>
  </div>

  <div id="app">
    <!-- Sidebar -->
    <div id="sidebar">
      <div id="sidebar-header">
        <h2>Chats</h2>
        <button id="new-chat-btn" title="New Chat">+</button>
      </div>
      <div id="sessions-list"></div>
    </div>

    <div id="overlay"></div>

    <!-- Main -->
    <div id="main">
      <header>
        <button id="menu-btn">☰</button>
        <h1 id="chat-title">Sprite Code</h1>
        <div id="status">Disconnected</div>
        <button id="settings-btn" title="Manage Sprites">⚙</button>
      </header>

      <div id="empty-state">
        <h2>Welcome to Sprite Code</h2>
        <p>Start a new chat to begin coding</p>
        <button id="start-chat-btn">New Chat</button>
      </div>

      <div id="messages"></div>

      <div id="input-area">
        <div id="image-preview">
          <div id="image-preview-inner">
            <img id="image-preview-img" src="" alt="Preview">
            <span id="image-preview-name"></span>
            <button id="remove-image">×</button>
          </div>
        </div>
        <div id="input-wrapper">
          <button id="attach-btn" title="Attach image">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
            </svg>
          </button>
          <input type="file" id="file-input" accept="image/*" hidden>
          <textarea id="input" placeholder="Message Claude..." rows="1" enterkeyhint="send"></textarea>
          <button id="send" disabled>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
              <line x1="22" y1="2" x2="11" y2="13"></line>
              <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Sprites Modal -->
  <div id="sprites-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Manage Sprites</h2>
        <button class="modal-close" id="close-sprites-modal">×</button>
      </div>
      <div class="modal-body">
        <div class="sprites-list" id="sprites-list"></div>
        <div class="add-sprite-form">
          <input type="text" id="sprite-name-input" placeholder="Sprite name (e.g., Work Sprite)">
          <input type="text" id="sprite-address-input" placeholder="Tailscale IP (e.g., 100.64.1.2)">
          <button class="add-sprite-btn" id="add-sprite-btn">Add Sprite</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.0/marked.min.js"></script>
  <script>
    // Elements
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    const menuBtn = document.getElementById('menu-btn');
    const newChatBtn = document.getElementById('new-chat-btn');
    const startChatBtn = document.getElementById('start-chat-btn');
    const sessionsList = document.getElementById('sessions-list');
    const chatTitle = document.getElementById('chat-title');
    const emptyState = document.getElementById('empty-state');
    const messagesEl = document.getElementById('messages');
    const inputArea = document.getElementById('input-area');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const statusEl = document.getElementById('status');
    const settingsBtn = document.getElementById('settings-btn');
    const attachBtn = document.getElementById('attach-btn');
    const fileInput = document.getElementById('file-input');
    const imagePreview = document.getElementById('image-preview');
    const imagePreviewImg = document.getElementById('image-preview-img');
    const imagePreviewName = document.getElementById('image-preview-name');
    const removeImageBtn = document.getElementById('remove-image');
    const spritesModal = document.getElementById('sprites-modal');
    const closeSpritesModal = document.getElementById('close-sprites-modal');
    const spritesList = document.getElementById('sprites-list');
    const spriteNameInput = document.getElementById('sprite-name-input');
    const spriteAddressInput = document.getElementById('sprite-address-input');
    const addSpriteBtn = document.getElementById('add-sprite-btn');
    const pullIndicator = document.getElementById('pull-indicator');

    // State
    let sessions = [];
    let currentSession = null;
    let ws = null;
    let currentAssistantMessage = null;
    let assistantContent = '';
    let sprites = [];
    let pendingImage = null; // { id, filename, mediaType, url, localUrl }

    // Configure marked
    marked.setOptions({
      highlight: (code, lang) => {
        if (lang && hljs.getLanguage(lang)) {
          return hljs.highlight(code, { language: lang }).value;
        }
        return hljs.highlightAuto(code).value;
      },
      breaks: true,
    });

    // Sidebar toggle
    function openSidebar() {
      sidebar.classList.add('open');
      overlay.classList.add('visible');
    }

    function closeSidebar() {
      sidebar.classList.remove('open');
      overlay.classList.remove('visible');
    }

    menuBtn.addEventListener('click', openSidebar);
    overlay.addEventListener('click', closeSidebar);

    // Sessions API
    async function loadSessions() {
      const res = await fetch('/api/sessions');
      sessions = await res.json();
      renderSessionsList();
      return sessions;
    }

    async function createSession(name) {
      const res = await fetch('/api/sessions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name }),
      });
      const session = await res.json();
      sessions.unshift(session);
      renderSessionsList();
      selectSession(session);
      closeSidebar();
    }

    async function deleteSession(id, e) {
      e.stopPropagation();
      if (!confirm('Delete this chat?')) return;
      await fetch(`/api/sessions/${id}`, { method: 'DELETE' });
      sessions = sessions.filter(s => s.id !== id);
      if (currentSession?.id === id) {
        currentSession = null;
        disconnectWs();
        showEmptyState();
      }
      renderSessionsList();
    }

    function renderSessionsList() {
      sessionsList.innerHTML = sessions.map(s => `
        <div class="session-item ${currentSession?.id === s.id ? 'active' : ''}" data-id="${s.id}">
          <div class="session-name">
            <span>${escapeHtml(s.name)}</span>
            <button class="session-delete" onclick="deleteSession('${s.id}', event)">×</button>
          </div>
          <div class="session-preview">${escapeHtml(s.lastMessage || 'No messages yet')}</div>
          <div class="session-time">${formatTime(s.lastMessageAt)}</div>
        </div>
      `).join('');

      sessionsList.querySelectorAll('.session-item').forEach(el => {
        el.addEventListener('click', () => {
          const session = sessions.find(s => s.id === el.dataset.id);
          if (session) {
            selectSession(session);
            closeSidebar();
          }
        });
      });
    }

    function formatTime(ts) {
      const d = new Date(ts);
      const now = new Date();
      if (d.toDateString() === now.toDateString()) {
        return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }
      return d.toLocaleDateString([], { month: 'short', day: 'numeric' });
    }

    function selectSession(session) {
      currentSession = session;
      chatTitle.textContent = session.name;
      emptyState.style.display = 'none';
      messagesEl.classList.add('active');
      inputArea.classList.add('active');
      messagesEl.innerHTML = '';
      renderSessionsList();
      connectWs(session.id);
    }

    function showEmptyState() {
      chatTitle.textContent = 'Sprite Code';
      emptyState.style.display = 'flex';
      messagesEl.classList.remove('active');
      inputArea.classList.remove('active');
      statusEl.textContent = 'Disconnected';
      statusEl.className = '';
    }

    // WebSocket
    function connectWs(sessionId) {
      disconnectWs();

      const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${location.host}/ws?session=${sessionId}`);

      ws.onopen = () => {
        statusEl.textContent = 'Connected';
        statusEl.className = 'connected';
        sendBtn.disabled = false;
      };

      ws.onclose = () => {
        statusEl.textContent = 'Disconnected';
        statusEl.className = 'error';
        sendBtn.disabled = true;
      };

      ws.onerror = () => {
        statusEl.textContent = 'Error';
        statusEl.className = 'error';
      };

      ws.onmessage = (event) => {
        try {
          const msg = JSON.parse(event.data);
          handleMessage(msg);
        } catch (e) {
          console.error('Failed to parse message:', e);
        }
      };
    }

    function disconnectWs() {
      if (ws) {
        ws.close();
        ws = null;
      }
      currentAssistantMessage = null;
      assistantContent = '';
    }

    function handleMessage(msg) {
      switch (msg.type) {
        case 'system':
          if (!msg.message.includes('Connected')) {
            addSystemMessage(msg.message);
          }
          break;

        case 'history':
          // Render stored message history
          if (msg.messages && Array.isArray(msg.messages)) {
            for (const m of msg.messages) {
              if (m.role === 'user') {
                // Build image URL if message has an attached image
                const imageUrl = m.image ? `/api/uploads/${currentSession.id}/${m.image.filename}` : null;
                addUserMessage(m.content, imageUrl);
              } else if (m.role === 'assistant') {
                addStoredAssistantMessage(m.content);
              }
            }
          }
          break;

        case 'refresh_sessions':
          // Refresh sidebar and update current chat title if changed
          loadSessions().then(() => {
            if (currentSession) {
              const updated = sessions.find(s => s.id === currentSession.id);
              if (updated && updated.name !== currentSession.name) {
                currentSession.name = updated.name;
                chatTitle.textContent = updated.name;
              }
            }
          });
          break;

        case 'processing':
          // Claude is still working (reconnected to running process)
          if (msg.isProcessing) {
            showThinkingIndicator();
          }
          break;

        case 'assistant':
          if (msg.message?.content) {
            handleAssistantContent(msg.message.content);
          }
          if (msg.stop_reason) {
            finalizeAssistantMessage();
          }
          break;

        case 'content_block_start':
          if (msg.content_block?.type === 'text') {
            startAssistantMessage();
          } else if (msg.content_block?.type === 'tool_use') {
            addToolIndicator(msg.content_block.name);
          }
          break;

        case 'content_block_delta':
          if (msg.delta?.type === 'text_delta') {
            appendAssistantText(msg.delta.text);
          }
          break;

        case 'message_stop':
          finalizeAssistantMessage();
          break;

        case 'result':
          if (msg.result) {
            removeToolIndicator();
          }
          break;
      }
      scrollToBottom();
    }

    function handleAssistantContent(content) {
      if (Array.isArray(content)) {
        for (const block of content) {
          if (block.type === 'text') {
            startAssistantMessage();
            appendAssistantText(block.text);
          } else if (block.type === 'tool_use') {
            addToolIndicator(block.name);
          }
        }
      } else if (typeof content === 'string') {
        startAssistantMessage();
        appendAssistantText(content);
      }
    }

    function startAssistantMessage() {
      if (!currentAssistantMessage) {
        removeThinkingIndicator();
        currentAssistantMessage = document.createElement('div');
        currentAssistantMessage.className = 'message assistant';
        currentAssistantMessage.innerHTML = `
          <div class="message-header">Claude</div>
          <div class="message-content streaming"></div>
        `;
        messagesEl.appendChild(currentAssistantMessage);
        assistantContent = '';
      }
    }

    function appendAssistantText(text) {
      if (!currentAssistantMessage) startAssistantMessage();
      assistantContent += text;
      const contentEl = currentAssistantMessage.querySelector('.message-content');
      contentEl.innerHTML = marked.parse(assistantContent);
      contentEl.classList.add('streaming');
      scrollToBottom();
    }

    function finalizeAssistantMessage() {
      if (currentAssistantMessage) {
        const contentEl = currentAssistantMessage.querySelector('.message-content');
        contentEl.classList.remove('streaming');
        contentEl.querySelectorAll('pre code').forEach(block => hljs.highlightElement(block));
        currentAssistantMessage = null;
        assistantContent = '';
      }
    }

    function addUserMessage(text, imageUrl = null) {
      const msg = document.createElement('div');
      msg.className = 'message user';
      let imageHtml = '';
      if (imageUrl) {
        imageHtml = `<img src="${imageUrl}" class="message-image" style="max-width: 200px; max-height: 200px; border-radius: 8px; margin-bottom: 8px; display: block;">`;
      }
      msg.innerHTML = `
        <div class="message-header">You</div>
        <div class="message-content">${imageHtml}${text ? escapeHtml(text) : ''}</div>
      `;
      messagesEl.appendChild(msg);
      scrollToBottom();
    }

    function addStoredAssistantMessage(text) {
      const msg = document.createElement('div');
      msg.className = 'message assistant';
      const contentEl = document.createElement('div');
      contentEl.className = 'message-content';
      contentEl.innerHTML = marked.parse(text);
      contentEl.querySelectorAll('pre code').forEach(block => hljs.highlightElement(block));
      msg.innerHTML = `<div class="message-header">Claude</div>`;
      msg.appendChild(contentEl);
      messagesEl.appendChild(msg);
      scrollToBottom();
    }

    function addSystemMessage(text) {
      const msg = document.createElement('div');
      msg.className = 'message system';
      msg.innerHTML = `<div class="message-content">${escapeHtml(text)}</div>`;
      messagesEl.appendChild(msg);
      scrollToBottom();
    }

    function addToolIndicator(toolName) {
      finalizeAssistantMessage();
      removeThinkingIndicator();
      const indicator = document.createElement('div');
      indicator.className = 'tool-indicator';
      indicator.innerHTML = `<div class="spinner"></div><span>Using <strong>${escapeHtml(toolName)}</strong>...</span>`;
      messagesEl.appendChild(indicator);
      scrollToBottom();
    }

    function removeToolIndicator() {
      const indicators = messagesEl.querySelectorAll('.tool-indicator');
      if (indicators.length > 0) {
        indicators[indicators.length - 1].remove();
      }
    }

    function showThinkingIndicator() {
      removeThinkingIndicator();
      const indicator = document.createElement('div');
      indicator.className = 'thinking-indicator';
      indicator.innerHTML = `
        <div class="thinking-dots">
          <span></span><span></span><span></span>
        </div>
        <span class="thinking-text">Claude is thinking...</span>
      `;
      messagesEl.appendChild(indicator);
      scrollToBottom();
    }

    function removeThinkingIndicator() {
      const indicator = messagesEl.querySelector('.thinking-indicator');
      if (indicator) indicator.remove();
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function scrollToBottom() {
      requestAnimationFrame(() => {
        messagesEl.scrollTop = messagesEl.scrollHeight;
      });
    }

    function send() {
      const text = inputEl.value.trim();
      const hasImage = pendingImage !== null;

      // Need either text or image to send
      if ((!text && !hasImage) || !ws || ws.readyState !== WebSocket.OPEN) return;

      // Build message payload
      const payload = { type: 'user', content: text };
      if (hasImage) {
        payload.imageId = pendingImage.id;
        payload.imageFilename = pendingImage.filename;
        payload.imageMediaType = pendingImage.mediaType;
      }

      addUserMessage(text, hasImage ? pendingImage.localUrl : null);
      ws.send(JSON.stringify(payload));
      showThinkingIndicator();

      // Clear input and image
      inputEl.value = '';
      inputEl.style.height = 'auto';
      clearPendingImage();
      inputEl.focus();
    }

    function clearPendingImage() {
      if (pendingImage?.localUrl) {
        URL.revokeObjectURL(pendingImage.localUrl);
      }
      pendingImage = null;
      imagePreview.classList.remove('has-image');
      imagePreviewImg.src = '';
      imagePreviewName.textContent = '';
    }

    async function uploadImage(file) {
      if (!currentSession) return;

      const formData = new FormData();
      formData.append('file', file);

      try {
        const res = await fetch(`/api/upload?session=${currentSession.id}`, {
          method: 'POST',
          body: formData,
        });

        if (!res.ok) {
          throw new Error(await res.text());
        }

        const data = await res.json();

        // Create local URL for preview
        const localUrl = URL.createObjectURL(file);

        pendingImage = {
          id: data.id,
          filename: data.filename,
          mediaType: data.mediaType,
          url: data.url,
          localUrl,
        };

        // Show preview
        imagePreviewImg.src = localUrl;
        imagePreviewName.textContent = file.name;
        imagePreview.classList.add('has-image');
      } catch (err) {
        console.error('Upload failed:', err);
        alert('Failed to upload image');
      }
    }

    // Event listeners
    inputEl.addEventListener('input', () => {
      inputEl.style.height = 'auto';
      inputEl.style.height = Math.min(inputEl.scrollHeight, 120) + 'px';
    });

    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        send();
      }
    });

    sendBtn.addEventListener('click', send);
    newChatBtn.addEventListener('click', () => createSession());
    startChatBtn.addEventListener('click', () => createSession());

    // Image upload handlers
    attachBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (file) {
        uploadImage(file);
      }
      fileInput.value = ''; // Reset so same file can be selected again
    });
    removeImageBtn.addEventListener('click', clearPendingImage);

    // Prevent zoom on double-tap
    let lastTouchEnd = 0;
    document.addEventListener('touchend', (e) => {
      const now = Date.now();
      if (now - lastTouchEnd <= 300) e.preventDefault();
      lastTouchEnd = now;
    }, false);

    // Make deleteSession global for onclick
    window.deleteSession = deleteSession;

    // Sprites management
    function openSpritesModal() {
      loadSprites();
      spritesModal.classList.add('open');
    }

    function closeSpritesModalFn() {
      spritesModal.classList.remove('open');
      spriteNameInput.value = '';
      spriteAddressInput.value = '';
    }

    async function loadSprites() {
      const res = await fetch('/api/sprites');
      sprites = await res.json();
      renderSpritesList();
    }

    function getCurrentSpriteAddress() {
      // Get current host without port
      return location.hostname;
    }

    function renderSpritesList() {
      const currentAddr = getCurrentSpriteAddress();

      if (sprites.length === 0) {
        spritesList.innerHTML = '<div class="sprites-empty">No sprites saved yet. Add one below!</div>';
        return;
      }

      spritesList.innerHTML = sprites.map(s => {
        const isCurrent = s.address === currentAddr;
        return `
          <div class="sprite-item ${isCurrent ? 'current' : ''}" data-id="${s.id}" data-address="${s.address}" data-port="${s.port}">
            <div class="sprite-info">
              <div class="sprite-name">
                ${escapeHtml(s.name)}
                ${isCurrent ? '<span class="sprite-current-badge">Current</span>' : ''}
              </div>
              <div class="sprite-address">${escapeHtml(s.address)}:${s.port}</div>
            </div>
            <button class="sprite-delete" onclick="deleteSprite('${s.id}', event)">×</button>
          </div>
        `;
      }).join('');

      spritesList.querySelectorAll('.sprite-item').forEach(el => {
        el.addEventListener('click', (e) => {
          if (e.target.classList.contains('sprite-delete')) return;
          const address = el.dataset.address;
          const port = el.dataset.port;
          navigateToSprite(address, port);
        });
      });
    }

    async function addSprite() {
      const name = spriteNameInput.value.trim();
      const address = spriteAddressInput.value.trim();

      if (!name || !address) {
        alert('Please enter both name and address');
        return;
      }

      await fetch('/api/sprites', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, address, port: 8080 }),
      });

      spriteNameInput.value = '';
      spriteAddressInput.value = '';
      loadSprites();
    }

    async function deleteSprite(id, e) {
      e.stopPropagation();
      if (!confirm('Delete this sprite?')) return;
      await fetch(`/api/sprites/${id}`, { method: 'DELETE' });
      loadSprites();
    }

    function navigateToSprite(address, port) {
      const protocol = location.protocol;
      const url = `${protocol}//${address}:${port}`;
      window.location.href = url;
    }

    // Make deleteSprite global for onclick
    window.deleteSprite = deleteSprite;

    // Sprites modal event listeners
    settingsBtn.addEventListener('click', openSpritesModal);
    closeSpritesModal.addEventListener('click', closeSpritesModalFn);
    spritesModal.addEventListener('click', (e) => {
      if (e.target === spritesModal) closeSpritesModalFn();
    });
    addSpriteBtn.addEventListener('click', addSprite);
    spriteAddressInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') addSprite();
    });

    // Pull to refresh
    let pullStartY = 0;
    let isPulling = false;
    let pullDistance = 0;
    const PULL_THRESHOLD = 80;

    function canPullRefresh() {
      // Only allow pull refresh when at top of scrollable content
      // and sidebar/modal are closed
      if (sidebar.classList.contains('open')) return false;
      if (spritesModal.classList.contains('open')) return false;

      // Check if messages area is at top or we're in empty state
      if (messagesEl.classList.contains('active')) {
        return messagesEl.scrollTop <= 0;
      }
      return true; // Empty state, always allow
    }

    document.addEventListener('touchstart', (e) => {
      if (!canPullRefresh()) return;
      pullStartY = e.touches[0].clientY;
      isPulling = true;
      pullDistance = 0;
    }, { passive: true });

    document.addEventListener('touchmove', (e) => {
      if (!isPulling || !canPullRefresh()) return;

      const currentY = e.touches[0].clientY;
      pullDistance = currentY - pullStartY;

      // Only show indicator when pulling down
      if (pullDistance > 0) {
        // Calculate indicator position (max 80px down)
        const progress = Math.min(pullDistance / PULL_THRESHOLD, 1);
        const translateY = -60 + (progress * 80);

        pullIndicator.style.transform = `translateX(-50%) translateY(${translateY}px)`;
        pullIndicator.style.transition = 'none';
        pullIndicator.classList.add('visible');

        if (pullDistance >= PULL_THRESHOLD) {
          pullIndicator.classList.add('ready');
        } else {
          pullIndicator.classList.remove('ready');
        }
      } else {
        pullIndicator.classList.remove('visible', 'ready');
      }
    }, { passive: true });

    document.addEventListener('touchend', () => {
      if (!isPulling) return;
      isPulling = false;

      pullIndicator.style.transition = '';

      if (pullDistance >= PULL_THRESHOLD) {
        // Trigger refresh
        pullIndicator.classList.remove('ready');
        pullIndicator.classList.add('refreshing');

        // Save current session before reload
        if (currentSession) {
          localStorage.setItem('lastSessionId', currentSession.id);
        }

        // Small delay for visual feedback, then reload
        setTimeout(() => {
          window.location.reload();
        }, 300);
      } else {
        // Reset indicator
        pullIndicator.classList.remove('visible', 'ready');
        pullIndicator.style.transform = '';
      }

      pullDistance = 0;
    }, { passive: true });

    // Init
    loadSessions().then(() => {
      // Restore last session if saved (e.g., after pull-to-refresh)
      const lastSessionId = localStorage.getItem('lastSessionId');
      if (lastSessionId) {
        localStorage.removeItem('lastSessionId');
        const session = sessions.find(s => s.id === lastSessionId);
        if (session) {
          selectSession(session);
        }
      }
    });
  </script>
</body>
</html>
